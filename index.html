<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ResellDeck — Futuristisches Reseller-Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/@tabler/icons-webfont@latest/tabler-icons.min.css">
  <style>
    :root {
      --bg: #0b0f1a;
      --card: rgba(16, 20, 35, 0.72);
      --muted: #9aa4bf;
      --text: #e8edff;
      --accent: #7c4dff;
      --accent2: #00e5ff;
      --ok: #00d48a;
      --warn: #ffb020;
      --danger: #ff4d67;
      --glass: blur(14px) saturate(130%);
      --radius: 18px;
      --shadow: 0 10px 35px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
      --gradient: radial-gradient(1000px 600px at 0% -10%, rgba(124,77,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 100% 110%, rgba(0,229,255,.18), transparent 60%),
                  linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0; background: var(--bg); color: var(--text); font-family: 'Space Grotesk', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      background-image: var(--gradient);
      background-attachment: fixed; 
    }

    a { color: var(--accent2); text-decoration: none }
    a:hover { text-decoration: underline }

    .container { max-width: 1200px; margin: 0 auto; padding: 28px; }

    .brand { display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.5px; }
    .brand .logo { width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, var(--accent), var(--accent2)); position: relative; box-shadow: 0 8px 28px rgba(124,77,255,.35), 0 8px 28px rgba(0,229,255,.25); }
    .brand .logo::after { content: ""; position: absolute; inset: 8px; border-radius: 9px; background: rgba(255,255,255,.2); filter: blur(6px); }

    .card { background: var(--card); backdrop-filter: var(--glass); border-radius: var(--radius); box-shadow: var(--shadow); }
    .card.pad { padding: 18px; }
    .row { display:flex; gap: 18px; flex-wrap: wrap }

    header.app { display:flex; align-items:center; justify-content:space-between; gap: 16px; padding: 18px 24px; position: sticky; top: 0; z-index: 5; background: linear-gradient(180deg, rgba(11,15,26,.88), rgba(11,15,26,.55) 60%, rgba(11,15,26,0)); border-bottom: 1px solid rgba(255,255,255,.06); }

    .chip { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius: 999px; background: rgba(255,255,255,.06); color: var(--muted); font-size: 12px; }

    input, select, textarea, button { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); color: var(--text); border-radius: 12px; padding: 12px 12px; outline: none; width: 100%; font: inherit; }
    input::placeholder, textarea::placeholder { color: #b9c3e4aa }
    label { font-size: 12px; color: var(--muted); margin-bottom: 8px; display:block }

    .btn { cursor: pointer; user-select: none; transition: .25s ease; border-radius: 12px; }
    .btn.primary { background: linear-gradient(135deg, var(--accent), var(--accent2)); border: none; color: #0a0e18; font-weight: 700; }
    .btn.ghost { background: transparent; border: 1px dashed rgba(255,255,255,.18); }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.05) }

    .auth-wrap { min-height: 100vh; display:grid; place-items:center; padding: 28px }
    .auth { max-width: 880px; width: 100%; display:grid; grid-template-columns: 1.2fr 1fr; overflow: hidden }
    .auth .left { padding: 28px; position:relative }
    .auth .right { padding: 28px; background: linear-gradient(160deg, rgba(124,77,255,.2), rgba(0,229,255,.12)); }
    .auth h1 { margin: 0 0 8px 0; }
    .auth p { margin: 0; color: var(--muted) }
    .auth .tabbar { display:flex; gap:8px; margin: 18px 0 12px }
    .auth .tabbar button { flex:1; padding: 10px 12px }

    form.grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px }
    form.grid .span2 { grid-column: 1 / -1 }

    .hidden { display:none !important }

    /* Dashboard */
    .layout { display:grid; grid-template-columns: 300px 1fr; gap: 18px; }
    @media (max-width: 960px) { .layout { grid-template-columns: 1fr } }

    .searchbar { display:flex; align-items:center; gap:12px; flex:1 }
    .searchbar input { width: 100% }

    .stats { display:grid; grid-template-columns: repeat(4, 1fr); gap: 14px }
    @media (max-width: 960px) { .stats { grid-template-columns: repeat(2, 1fr) } }
    .stat { padding:16px; position:relative; overflow:hidden }
    .stat .label { color: var(--muted); font-size: 12px }
    .stat .value { font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 22px; margin-top:6px }
    .stat .glow { position:absolute; inset: -1px; border-radius: var(--radius); pointer-events:none; box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }

    .list { display:grid; gap: 12px }

    .item { display:grid; grid-template-columns: 1fr 160px 140px 110px 90px 40px; gap: 10px; align-items:center; padding: 10px 12px; }
    .item .title { font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .item .url { font-size:12px; color: var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .item .platform { font-size:12px; }
    .item .badge { padding:6px 10px; border-radius: 999px; font-size:12px; display:inline-flex; align-items:center; gap:6px }
    .badge.sourced { background: rgba(124,77,255,.18); color: #cbb6ff }
    .badge.contacted { background: rgba(0,229,255,.18); color: #a9f6ff }
    .badge.negotiating { background: rgba(255,176,32,.18); color: #ffd391 }
    .badge.bought { background: rgba(0,212,138,.18); color: #a6ffd9 }
    .badge.listed { background: rgba(255,255,255,.08); color: #dfe7ff }
    .badge.sold { background: rgba(0,212,138,.25); color: #7effc7; border: 1px solid rgba(0,212,138,.35) }

    .actions { display:flex; gap:8px; justify-content:flex-end }
    .iconbtn { width:36px; height:36px; display:grid; place-items:center; border-radius: 10px; border: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.04); cursor: pointer }
    .iconbtn:hover { filter: brightness(1.1) }

    .subtle { color: var(--muted); font-size: 12px }

    .footer { margin-top: 24px; display:flex; gap:12px; flex-wrap:wrap; justify-content: space-between; align-items:center }

    .divider { height:1px; background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.12), rgba(255,255,255,0)); margin: 14px 0 }

    .template { background: rgba(255,255,255,.05); padding: 12px; border-radius: 12px; border: 1px dashed rgba(255,255,255,.12) }
    .template .row { align-items:center }

    .modal { position: fixed; inset: 0; display:none; place-items:center; background: rgba(3,6,10,.6); z-index: 20 }
    .modal .dialog { max-width: 520px; width: calc(100% - 36px); }
    .modal.show { display:grid }

    .kicker { font-size:12px; color: var(--muted); text-transform: uppercase; letter-spacing: .14em }

    .taglist { display:flex; gap:8px; flex-wrap: wrap }
    .tag { background: rgba(255,255,255,.08); padding: 6px 10px; border-radius: 999px; font-size: 12px }

    .pill { border-radius: 999px; padding: 6px 10px; background: rgba(255,255,255,.06); font-size:12px }

    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px }
    @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr } }

    .note { font-size: 12px; color: var(--muted) }

    .comingsoon { opacity: .75; pointer-events: none }
  </style>
</head>
<body>
  <header class="app">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div>ResellDeck</div>
        <div class="subtle">Kleinanzeigen & eBay Workflow, aber hübsch ✨</div>
      </div>
    </div>
    <div class="searchbar">
      <i class="ti ti-search"></i>
      <input id="search" placeholder="Suche Links, Titel, Tags… (Strg+/)" />
    </div>
    <div class="chip" id="userChip"><i class="ti ti-user"></i><span id="userEmail">Gast</span></div>
    <button class="btn ghost" id="logoutBtn"><i class="ti ti-logout"></i>&nbsp;Logout</button>
  </header>

  <div id="authView" class="auth-wrap">
    <div class="auth card">
      <div class="left">
        <div class="brand" style="margin-bottom:12px">
          <div class="logo" style="width:32px;height:32px"></div>
          <div>ResellDeck</div>
        </div>
        <h1>Dein futuristisches Reseller-Dashboard</h1>
        <p>
          Speichere Links, behalte Deals im Blick, nutze Vorlagen – alles im Browser. <strong>Demo-Login</strong> ohne Server, Daten liegen nur in <em>deinem</em> Browser.
          <br><span class="note">Optionaler Cloud‑Sync via Supabase ist im Code vorbereitet (siehe Hinweis rechts).</span>
        </p>
        <div class="divider"></div>
        <div class="tabbar">
          <button id="tabLogin" class="btn">Login</button>
          <button id="tabRegister" class="btn ghost">Account erstellen</button>
        </div>
        <form id="loginForm" class="grid">
          <div class="span2">
            <label>E-Mail</label>
            <input required type="email" id="loginEmail" placeholder="du@beispiel.de" autocomplete="username" />
          </div>
          <div class="span2">
            <label>Passwort</label>
            <input required type="password" id="loginPassword" placeholder="••••••••" autocomplete="current-password" />
          </div>
          <div class="span2">
            <button class="btn primary" type="submit">Einloggen</button>
          </div>
        </form>

        <form id="registerForm" class="grid hidden">
          <div class="span2">
            <label>E-Mail</label>
            <input required type="email" id="regEmail" placeholder="du@beispiel.de" autocomplete="username" />
          </div>
          <div>
            <label>Passwort</label>
            <input required type="password" id="regPassword" placeholder="mind. 8 Zeichen" autocomplete="new-password" />
          </div>
          <div>
            <label>Passwort (Wiederholen)</label>
            <input required type="password" id="regPassword2" placeholder="nochmal" autocomplete="new-password" />
          </div>
          <div class="span2">
            <button class="btn primary" type="submit">Account erstellen</button>
          </div>
          <p class="note span2">Hinweis: Client-Login (LocalStorage) oder 
            <span class="pill">Supabase‑Auth</span> wenn konfiguriert.</p>
        </form>
      </div>
      <div class="right">
        <div class="kicker">Features</div>
        <ul>
          <li>🔗 Link-Speicher mit Status-Workflow</li>
          <li>💬 Verhandlungs-Vorlagen & Copy-Buttons</li>
          <li>📈 Profit-Rechner & Mini-Statistiken</li>
          <li>⏰ Erinnerungen/Deadlines pro Deal</li>
          <li>⬇️ Export/⬆️ Import als JSON</li>
          <li>🤖 <em>Coming Soon:</em> AI-Listing-Optimierer</li>
        </ul>
        <div class="divider"></div>
        <div class="kicker">Cloud‑Sync (optional)</div>
        <p class="note">
          Trage in der <code>&lt;script type="module"&gt;</code>-Sektion deine 
          <strong>SUPABASE_URL</strong> &amp; <strong>SUPABASE_ANON_KEY</strong> ein.
          Danach ist Login/Sync automatisch online.
        </p>
        <div class="divider"></div>
        <div class="kicker">Demo-Zugang</div>
        <p class="note">Du kannst dir einfach selbst einen Account anlegen. Alternativ: <code class="pill">demo@deck.dev</code> / <code class="pill">demo1234</code> (lokal).</p>
      </div>
    </div>
  </div>

  <main id="appView" class="container hidden">
    <div class="stats">
      <div class="card stat"><div class="glow"></div><div class="label">Gespeicherte Links</div><div id="statTotal" class="value">0</div></div>
      <div class="card stat"><div class="glow"></div><div class="label">Aktiv (Kontakt/Laufend)</div><div id="statActive" class="value">0</div></div>
      <div class="card stat"><div class="glow"></div><div class="label">Gewinn (prognostiziert)</div><div id="statProfit" class="value">€0</div></div>
      <div class="card stat"><div class="glow"></div><div class="label">Fällige Erinnerungen</div><div id="statDue" class="value">0</div></div>
    </div>

    <div class="layout" style="margin-top:18px">
      <aside class="card pad">
        <h3 style="margin-top:0">Link speichern</h3>
        <form id="addForm">
          <label>URL</label>
          <input id="fUrl" type="url" placeholder="https://www.kleinanzeigen.de/... oder https://www.ebay.de/..." required />
          <div class="grid-2" style="margin-top:12px">
            <div>
              <label>Titel</label>
              <input id="fTitle" placeholder="z.B. iPhone 13, sehr guter Zustand" />
            </div>
            <div>
              <label>Plattform</label>
              <select id="fPlatform">
                <option>Automatisch</option>
                <option>eBay</option>
                <option>Kleinanzeigen</option>
                <option>Sonstiges</option>
              </select>
            </div>
          </div>
          <div class="grid-2" style="margin-top:12px">
            <div>
              <label>Einkaufspreis (Ziel)</label>
              <input id="fBuy" type="number" inputmode="decimal" placeholder="€" />
            </div>
            <div>
              <label>Verkaufspreis (Ziel)</label>
              <input id="fSell" type="number" inputmode="decimal" placeholder="€" />
            </div>
          </div>
          <div class="grid-2" style="margin-top:12px">
            <div>
              <label>Status</label>
              <select id="fStatus">
                <option>gesichtet</option>
                <option>kontaktiert</option>
                <option>verhandlung</option>
                <option>gekauft</option>
                <option>gelistet</option>
                <option>verkauft</option>
              </select>
            </div>
            <div>
              <label>Erinnerung</label>
              <input id="fDue" type="date" />
            </div>
          </div>
          <label style="margin-top:12px">Tags (Komma-getrennt)</label>
          <input id="fTags" placeholder="iphone, 128gb, spacegray" />
          <label style="margin-top:12px">Notiz</label>
          <textarea id="fNote" rows="3" placeholder="Zustand, Standort, Argumente…"></textarea>
          <button class="btn primary" style="margin-top:14px" type="submit"><i class="ti ti-bookmark-plus"></i>&nbsp;Speichern</button>
        </form>

        <div class="divider"></div>
        <div>
          <h3 style="margin:0 0 8px 0">Vorlagen (Copy & Paste)</h3>
          <div class="template">
            <div class="row">
              <div style="flex:1">
                <div class="kicker">Erstkontakt</div>
                <p class="note" style="margin:4px 0 8px">Höfliche Anfrage mit Preisanker</p>
              </div>
              <button class="btn ghost" id="copyTpl1"><i class="ti ti-copy"></i>&nbsp;Kopieren</button>
            </div>
            <pre id="tpl1" class="subtle" style="white-space:pre-wrap; user-select:all;">Hi! 😊 Ist der Artikel noch verfügbar? Würde heute abholen/zzgl. Versand nehmen. Wenn  <Zielpreis>  für dich passt, bin ich sofort dabei. Danke dir!</pre>
          </div>
          <div class="template" style="margin-top:10px">
            <div class="row">
              <div style="flex:1">
                <div class="kicker">Gegenangebot</div>
                <p class="note" style="margin:4px 0 8px">Kurz & freundlich</p>
              </div>
              <button class="btn ghost" id="copyTpl2"><i class="ti ti-copy"></i>&nbsp;Kopieren</button>
            </div>
            <pre id="tpl2" class="subtle" style="white-space:pre-wrap; user-select:all;">Danke fürs schnelle Feedback! Ich könnte  <MeinPreis>  anbieten und heute/sofort zahlen. Deal?</pre>
          </div>

          <div class="divider"></div>
          <h3 style="margin:0 0 8px 0">Export & Import</h3>
          <div class="row">
            <button class="btn ghost" id="exportBtn"><i class="ti ti-download"></i>&nbsp;Daten exportieren (JSON)</button>
            <label class="btn ghost" style="cursor:pointer"><i class="ti ti-upload"></i>&nbsp;Importieren<input id="importFile" type="file" accept="application/json" style="display:none"></label>
          </div>
          <p class="note" style="margin-top:8px">Sichert deine Links in eine Datei oder importiert sie später wieder.</p>

          <div class="divider"></div>
          <button class="btn" id="wipeBtn" style="width:100%; background: rgba(255,77,103,.1); border:1px solid rgba(255,77,103,.35); color:#ffcfda"><i class="ti ti-alert-triangle"></i>&nbsp;Lokale Daten löschen</button>
        </div>
      </aside>

      <section class="card pad">
        <div class="row" style="align-items:center; justify-content:space-between">
          <h3 style="margin:0">Deine Deals</h3>
          <div class="row" style="align-items:center">
            <select id="filterStatus">
              <option value="">Alle Status</option>
              <option value="gesichtet">Gesichtet</option>
              <option value="kontaktiert">Kontaktiert</option>
              <option value="verhandlung">Verhandlung</option>
              <option value="gekauft">Gekauft</option>
              <option value="gelistet">Gelistet</option>
              <option value="verkauft">Verkauft</option>
            </select>
            <select id="sortBy">
              <option value="createdDesc">Neueste zuerst</option>
              <option value="profitDesc">Höchster Profit</option>
              <option value="dueAsc">Nächste Fälligkeit</option>
              <option value="titleAsc">Titel A→Z</option>
            </select>
          </div>
        </div>
        <div class="list" id="list"></div>
      </section>
    </div>

    <div class="footer">
      <div class="subtle">💡 Tipp: Zieh die URL per Copy/Paste rein. Mit <strong>Strg+/</strong> öffnest du die Suche.</div>
      <div class="chip comingsoon"><i class="ti ti-sparkles"></i> AI-Listing-Optimierer – bald™️</div>
    </div>
  </main>

  <div id="profitModal" class="modal">
    <div class="dialog card pad">
      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
        <h3 style="margin:0">Profit-Rechner</h3>
        <button class="iconbtn" id="profitClose"><i class="ti ti-x"></i></button>
      </div>
      <div class="grid-2">
        <div>
          <label>Einkaufspreis</label>
          <input id="pmBuy" type="number" inputmode="decimal" />
        </div>
        <div>
          <label>Verkaufspreis</label>
          <input id="pmSell" type="number" inputmode="decimal" />
        </div>
        <div>
          <label>Plattformgebühren (%)</label>
          <input id="pmFeePct" type="number" inputmode="decimal" value="11" />
        </div>
        <div>
          <label>Versandkosten</label>
          <input id="pmShip" type="number" inputmode="decimal" value="0" />
        </div>
      </div>
      <div class="divider"></div>
      <div class="row" style="align-items:center; justify-content:space-between">
        <div>
          <div class="kicker">Prognose</div>
          <div id="pmResult" style="font-family:'JetBrains Mono', ui-monospace; font-size:20px">€0</div>
        </div>
        <button class="btn primary" id="pmApply"><i class="ti ti-check"></i>&nbsp;In Deal übernehmen</button>
      </div>
    </div>
  </div>

  <template id="itemTmpl">
    <div class="item card">
      <div>
        <div class="title"></div>
        <div class="url"></div>
      </div>
      <div class="platform"></div>
      <div class="status"></div>
      <div class="profit" style="font-family:'JetBrains Mono', ui-monospace">€0</div>
      <div class="due subtle">–</div>
      <div class="actions">
        <button class="iconbtn open"><i class="ti ti-external-link"></i></button>
        <button class="iconbtn edit"><i class="ti ti-pencil"></i></button>
        <button class="iconbtn calc"><i class="ti ti-calculator"></i></button>
        <button class="iconbtn del" title="Löschen" style="border-color: rgba(255,77,103,.35)"><i class="ti ti-trash"></i></button>
      </div>
    </div>
  </template>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // ===== Supabase Config (optional – für Cloud‑Sync) =====
    // Trage hier deine Werte ein, um die Online‑Funktionen zu aktivieren
    const SUPABASE_URL = 'https://okycsoofgaddpxbircit.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9reWNzb29mZ2FkZHB4YmlyY2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NTM0NjUsImV4cCI6MjA3MzAyOTQ2NX0.3DTX4GzHRoSSpqsqXQ4v04UVreUHIthukk223uFwxTM';
    const CLOUD = !!(SUPABASE_URL && SUPABASE_ANON_KEY);
    const sb = CLOUD ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

    // ===== Utilities =====
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
    const fmtMoney = (n) => `€${Number(n||0).toLocaleString('de-DE', {maximumFractionDigits: 2})}`;
    const todayISO = () => new Date().toISOString().slice(0,10);

    // Password hashing (client-side demo only – für lokalen Modus)
    async function sha256Hex(str){
      const enc = new TextEncoder();
      const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    const randHex = (len=16) => [...crypto.getRandomValues(new Uint8Array(len))].map(x=>x.toString(16).padStart(2,'0')).join('');

    // Storage (Local Mode)
    const USERS_KEY = 'rd_users_v1';
    const SESSION_KEY = 'rd_session_v1';
    function readUsers(){ try { return JSON.parse(localStorage.getItem(USERS_KEY) || '{}') } catch { return {} } }
    function writeUsers(obj){ localStorage.setItem(USERS_KEY, JSON.stringify(obj)) }

    function dataKey(email){ return `rd_data_${email}` }
    function readData(email){ try { return JSON.parse(localStorage.getItem(dataKey(email)) || '{}') } catch { return {} } }
    function writeData(email, obj){ localStorage.setItem(dataKey(email), JSON.stringify(obj)) }

    function defaultData(){
      return {
        items: [],
        templates: {
          first: $('#tpl1').textContent.trim(),
          counter: $('#tpl2').textContent.trim()
        },
        settings: { feePct: 11 }
      }
    }

    // Auth State
    let currentUser = null; // email (lokal) oder Supabase-Email
    function setSession(email){ if(email){ localStorage.setItem(SESSION_KEY, email); } else { localStorage.removeItem(SESSION_KEY) } }
    function getSession(){ return localStorage.getItem(SESSION_KEY) }

    function platformFromUrl(u){
      try {
        const h = new URL(u).hostname;
        if(/kleinanzeigen\.de|ebay-kleinanzeigen\.de/i.test(h)) return 'Kleinanzeigen';
        if(/ebay\./i.test(h)) return 'eBay';
      } catch {}
      return 'Sonstiges';
    }

    function statusBadge(s){
      const map = { gesichtet:'sourced', kontaktiert:'contacted', verhandlung:'negotiating', gekauft:'bought', gelistet:'listed', verkauft:'sold' };
      const cls = map[s] || 'sourced';
      const span = document.createElement('span');
      span.className = `badge ${cls}`;
      span.textContent = s.charAt(0).toUpperCase()+s.slice(1);
      return span;
    }

    function computeProfit(it, feePctFallback=11){
      const buy = Number(it.buy || 0);
      const sell = Number(it.sell || 0);
      const feePct = Number(typeof it.feePct === 'number' ? it.feePct : feePctFallback);
      const fees = sell * (feePct/100);
      const ship = Number(it.ship || 0);
      return Math.round((sell - fees - ship - buy) * 100) / 100;
    }

    function recalcStats(){
      const data = readData(currentUser) || defaultData();
      const items = data.items || [];
      $('#statTotal').textContent = items.length;
      $('#statActive').textContent = items.filter(i=>['kontaktiert','verhandlung','gelistet'].includes(i.status)).length;
      const profit = items.reduce((sum,i)=> sum + (i.status==='verkauft' || i.sell ? computeProfit(i, data.settings.feePct) : 0), 0);
      $('#statProfit').textContent = fmtMoney(profit);
      const due = items.filter(i=> i.due && i.due <= todayISO()).length;
      $('#statDue').textContent = due;
    }

    function renderList(){
      const data = readData(currentUser) || defaultData();
      const q = $('#search').value.trim().toLowerCase();
      const fStatus = $('#filterStatus').value;
      const sortBy = $('#sortBy').value;
      let items = [...(data.items||[])];
      // filter
      if(q){ items = items.filter(i=> (i.title||'').toLowerCase().includes(q) || (i.url||'').toLowerCase().includes(q) || (i.tags||'').toLowerCase().includes(q)) }
      if(fStatus){ items = items.filter(i=> i.status === fStatus) }
      // sort
      items.sort((a,b)=>{
        switch(sortBy){
          case 'profitDesc': return computeProfit(b, data.settings.feePct) - computeProfit(a, data.settings.feePct);
          case 'dueAsc': return (a.due||'9999-12-31').localeCompare(b.due||'9999-12-31');
          case 'titleAsc': return (a.title||'').localeCompare(b.title||'');
          default: return (b.created||0) - (a.created||0);
        }
      });

      const list = $('#list');
      list.innerHTML = '';
      const tmpl = $('#itemTmpl');
      for(const it of items){
        const row = tmpl.content.firstElementChild.cloneNode(true);
        $('.title', row).textContent = it.title || '(ohne Titel)';
        $('.url', row).textContent = it.url;
        const plat = $('.platform', row);
        plat.innerHTML = `<span class="chip"><i class="ti ti-brand-${it.platform==='eBay'?'ebay':'cash'}"></i>${it.platform}</span>`;
        const st = $('.status', row);
        st.innerHTML = '';
        st.appendChild(statusBadge(it.status || 'gesichtet'));
        $('.profit', row).textContent = fmtMoney(computeProfit(it, data.settings.feePct));
        $('.due', row).innerHTML = it.due ? (it.due <= todayISO() ? `<span style="color:var(--warn)">${it.due}</span>` : it.due) : '–';

        $('.open', row).addEventListener('click', ()=> window.open(it.url, '_blank'));
        $('.del', row).addEventListener('click', ()=> onDelete(it.id));
        $('.edit', row).addEventListener('click', ()=> editItem(it.id));
        $('.calc', row).addEventListener('click', ()=> openProfit(it.id));

        list.appendChild(row);
      }

      recalcStats();
    }

    function editItem(id){
      const data = readData(currentUser) || defaultData();
      const it = data.items.find(x=>x.id===id);
      if(!it) return;
      // Pre-fill the add form for quick editing
      $('#fUrl').value = it.url || '';
      $('#fTitle').value = it.title || '';
      $('#fPlatform').value = ['eBay','Kleinanzeigen','Sonstiges'].includes(it.platform) ? it.platform : 'Automatisch';
      $('#fBuy').value = it.buy || '';
      $('#fSell').value = it.sell || '';
      $('#fStatus').value = it.status || 'gesichtet';
      $('#fDue').value = it.due || '';
      $('#fTags').value = it.tags || '';
      $('#fNote').value = it.note || '';
      $('#addForm').dataset.editing = id;
      $('#addForm').querySelector('button[type="submit"]').innerHTML = '<i class="ti ti-device-floppy"></i>&nbsp;Änderungen speichern';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Profit modal
    let profitContextId = null;
    function openProfit(id){
      const data = readData(currentUser) || defaultData();
      const it = data.items.find(x=>x.id===id);
      profitContextId = id;
      $('#pmBuy').value = it?.buy || '';
      $('#pmSell').value = it?.sell || '';
      $('#pmFeePct').value = typeof it?.feePct === 'number' ? it.feePct : (data.settings.feePct||11);
      $('#pmShip').value = it?.ship || 0;
      updateProfitResult();
      $('#profitModal').classList.add('show');
    }
    function updateProfitResult(){
      const buy = Number($('#pmBuy').value||0);
      const sell = Number($('#pmSell').value||0);
      const feePct = Number($('#pmFeePct').value||0);
      const ship = Number($('#pmShip').value||0);
      const fees = sell * (feePct/100);
      const p = Math.round((sell - fees - ship - buy) * 100) / 100;
      $('#pmResult').textContent = fmtMoney(p);
    }

    // Events for profit modal
    ['pmBuy','pmSell','pmFeePct','pmShip'].forEach(id=> $('#'+id).addEventListener('input', updateProfitResult));
    $('#profitClose').addEventListener('click', ()=> $('#profitModal').classList.remove('show'));
    $('#pmApply').addEventListener('click', ()=>{
      const data = readData(currentUser) || defaultData();
      const it = data.items.find(x=>x.id===profitContextId);
      if(!it) return;
      it.buy = Number($('#pmBuy').value||0);
      it.sell = Number($('#pmSell').value||0);
      it.feePct = Number($('#pmFeePct').value||0);
      it.ship = Number($('#pmShip').value||0);
      writeData(currentUser, data);
      syncUpOne(it).catch(()=>{});
      $('#profitModal').classList.remove('show');
      renderList();
    });

    // ===== Auth UI switching =====
    const loginForm = $('#loginForm');
    const registerForm = $('#registerForm');
    const tabLogin = $('#tabLogin');
    const tabRegister = $('#tabRegister');

    tabLogin.addEventListener('click', ()=>{ registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); tabLogin.classList.remove('ghost'); tabRegister.classList.add('ghost'); });
    tabRegister.addEventListener('click', ()=>{ loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); tabRegister.classList.remove('ghost'); tabLogin.classList.add('ghost'); });

    // ===== Local Auth (Fallback) =====
    async function attachLocalAuth(){
      registerForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = $('#regEmail').value.trim().toLowerCase();
        const pw = $('#regPassword').value;
        const pw2 = $('#regPassword2').value;
        if(pw.length < 8) return alert('Passwort zu kurz (min. 8 Zeichen).');
        if(pw !== pw2) return alert('Passwörter stimmen nicht überein.');
        const users = readUsers();
        if(users[email]) return alert('E-Mail bereits registriert.');
        const salt = randHex(16);
        const hash = await sha256Hex(pw + ':' + salt);
        users[email] = { salt, hash, created: Date.now() };
        writeUsers(users);
        writeData(email, defaultData());
        alert('Account erstellt! Du kannst dich jetzt einloggen.');
        tabLogin.click();
      });

      loginForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = $('#loginEmail').value.trim().toLowerCase();
        const pw = $('#loginPassword').value;
        const users = readUsers();
        const u = users[email];
        if(!u) return alert('Unbekannte E-Mail. Bitte registrieren.');
        const hash = await sha256Hex(pw + ':' + u.salt);
        if(hash !== u.hash) return alert('Falsches Passwort.');
        currentUser = email;
        setSession(email);
        $('#userEmail').textContent = email;
        $('#authView').classList.add('hidden');
        $('#appView').classList.remove('hidden');
        if(!(readData(email)?.items?.length)) seedSamples();
        renderList();
        recalcStats();
      });

      $('#logoutBtn').addEventListener('click', ()=>{ currentUser=null; setSession(null); $('#appView').classList.add('hidden'); $('#authView').classList.remove('hidden'); $('#loginEmail').focus(); });
      $('#wipeBtn').addEventListener('click', ()=>{ if(!currentUser) return; if(confirm('Wirklich lokale Daten löschen?')){ const users = readUsers(); delete users[currentUser]; writeUsers(users); localStorage.removeItem(dataKey(currentUser)); setSession(null); currentUser=null; location.reload(); }});
    }

    // ===== Cloud Auth (Supabase) =====
    async function attachCloudAuth(){
      // Registrierung in Supabase (evtl. E-Mail-Bestätigung in Auth-Einstellungen deaktivieren)
      registerForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = $('#regEmail').value.trim().toLowerCase();
        const password = $('#regPassword').value;
        const pw2 = $('#regPassword2').value;
        if(password.length < 8) return alert('Passwort zu kurz (min. 8 Zeichen).');
        if(password !== pw2) return alert('Passwörter stimmen nicht überein.');
        const { error } = await sb.auth.signUp({ email, password });
        if(error) return alert(error.message);
        alert('Account erstellt! Prüfe ggf. dein Postfach (Bestätigung).');
        tabLogin.click();
      });

      loginForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = $('#loginEmail').value.trim().toLowerCase();
        const password = $('#loginPassword').value;
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if(error) return alert(error.message);
        const user = data.user;
        currentUser = user.email;
        setSession(currentUser);
        $('#userEmail').textContent = currentUser;
        $('#authView').classList.add('hidden');
        $('#appView').classList.remove('hidden');
        await syncDown();
        renderList();
        recalcStats();
      });

      $('#logoutBtn').addEventListener('click', async ()=>{ await sb.auth.signOut(); currentUser=null; setSession(null); $('#appView').classList.add('hidden'); $('#authView').classList.remove('hidden'); $('#loginEmail').focus(); });
      $('#wipeBtn').addEventListener('click', ()=>{ if(!currentUser) return; if(confirm('Nur der lokale Cache wird gelöscht. (Cloud-Daten bleiben bestehen)')){ localStorage.removeItem(dataKey(currentUser)); location.reload(); }});
    }

    // ===== CRUD Hooks (lokal + optional Cloud-Upserts) =====
    async function onDelete(id){
      const data = readData(currentUser) || defaultData();
      if(confirm('Diesen Eintrag löschen?')){
        const it = data.items.find(x=>x.id===id);
        data.items = data.items.filter(x=>x.id!==id);
        writeData(currentUser, data);
        renderList();
        recalcStats();
        if(CLOUD) { try { await sb.from('deals').delete().eq('id', id); } catch{} }
      }
    }

    async function syncUpOne(it){
      if(!CLOUD) return;
      try {
        const { data: u } = await sb.auth.getUser();
        const row = toRow(it, u?.user?.id);
        await sb.from('deals').upsert(row);
      } catch {}
    }

    async function syncDown(){
      if(!CLOUD) return;
      const { data: rows, error } = await sb.from('deals').select('*').order('created', { ascending: false });
      if(error){ console.warn(error); return; }
      const email = (await sb.auth.getUser()).data.user.email;
      currentUser = email; setSession(email); $('#userEmail').textContent = email;
      const data = readData(email) || defaultData();
      data.items = (rows||[]).map(fromRow);
      writeData(email, data);
    }

    function toRow(it, userId){
      return {
        id: it.id,
        user_id: userId,
        created: it.created || Date.now(),
        url: it.url || null,
        title: it.title || null,
        platform: it.platform || null,
        buy: it.buy ?? null,
        sell: it.sell ?? null,
        fee_pct: (typeof it.feePct==='number'? it.feePct : null),
        ship: it.ship ?? null,
        status: it.status || null,
        due: it.due || null,
        tags: it.tags || null,
        note: it.note || null
      };
    }
    function fromRow(r){
      return {
        id: r.id,
        created: r.created,
        url: r.url,
        title: r.title,
        platform: r.platform||'Sonstiges',
        buy: Number(r.buy ?? 0),
        sell: Number(r.sell ?? 0),
        feePct: typeof r.fee_pct==='number'? r.fee_pct : undefined,
        ship: Number(r.ship ?? 0),
        status: r.status||'gesichtet',
        due: r.due || '',
        tags: r.tags || '',
        note: r.note || ''
      };
    }

    // ===== Add / Update item (Form) =====
    $('#addForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = readData(currentUser) || defaultData();
      const editingId = e.currentTarget.dataset.editing || null;

      const url = $('#fUrl').value.trim();
      const title = $('#fTitle').value.trim();
      let platform = $('#fPlatform').value;
      if(platform === 'Automatisch') platform = platformFromUrl(url);
      const buy = Number($('#fBuy').value || 0);
      const sell = Number($('#fSell').value || 0);
      const status = $('#fStatus').value;
      const due = $('#fDue').value || '';
      const tags = $('#fTags').value.trim();
      const note = $('#fNote').value.trim();

      if(editingId){
        const it = data.items.find(x=>x.id===editingId);
        if(!it) return;
        Object.assign(it, { url, title, platform, buy, sell, status, due, tags, note });
        e.currentTarget.dataset.editing = '';
        e.currentTarget.querySelector('button[type="submit"]').innerHTML = '<i class="ti ti-bookmark-plus"></i>&nbsp;Speichern';
        writeData(currentUser, data);
        await syncUpOne(it);
      } else {
        const it = { id: 'i_'+randHex(8), created: Date.now(), url, title, platform, buy, sell, status, due, tags, note, ship: 0 };
        data.items.unshift(it);
        writeData(currentUser, data);
        await syncUpOne(it);
      }

      e.currentTarget.reset();
      renderList();
    });

    // Search & filters
    $('#search').addEventListener('input', renderList);
    $('#filterStatus').addEventListener('change', renderList);
    $('#sortBy').addEventListener('change', renderList);
    window.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.key === '/') { e.preventDefault(); $('#search').focus() } });

    // Copy templates
    $('#copyTpl1').addEventListener('click', ()=>copyText($('#tpl1').textContent));
    $('#copyTpl2').addEventListener('click', ()=>copyText($('#tpl2').textContent));
    async function copyText(t){ try { await navigator.clipboard.writeText(t); alert('Vorlage kopiert!') } catch { prompt('Kopiere manuell:', t) } }

    // Export / Import (arbeitet auf dem lokalen Cache; in Cloud‑Modus kannst du danach hochladen via Sync)
    $('#exportBtn').addEventListener('click', ()=>{
      if(!currentUser) return;
      const data = readData(currentUser) || defaultData();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `reselldeck_${currentUser.replace(/[^a-z0-9]/gi,'_')}.json`; a.click(); URL.revokeObjectURL(a.href);
    });
    $('#importFile').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const txt = await file.text();
      try {
        const obj = JSON.parse(txt);
        const data = readData(currentUser) || defaultData();
        data.items = Array.isArray(obj.items) ? obj.items : data.items;
        data.templates = obj.templates || data.templates;
        data.settings = obj.settings || data.settings;
        writeData(currentUser, data);
        renderList();
        alert('Import erfolgreich.');
        if(CLOUD){ // optional hochladen
          for(const it of data.items){ await syncUpOne(it); }
        }
      } catch(err){ alert('Import fehlgeschlagen: ' + err.message); }
      e.target.value = '';
    });

    // Seed sample data (nur wenn lokal neu)
    function seedSamples(){
      const email = currentUser; const data = readData(email) || defaultData(); if((data.items||[]).length) return;
      const now = Date.now();
      data.items = [
        { id:'i_'+randHex(6), created: now-300000, url:'https://www.kleinanzeigen.de/s-anzeige/sony-a7-iii-kit/1234567890', title:'Sony A7 III (Kit) – Top Zustand', platform:'Kleinanzeigen', buy:750, sell:1050, feePct:0, ship:0, status:'verhandlung', due: todayISO(), tags:'kamera, sony, vollformat', note:'Mit 2 Akkus, 24-70mm. Angebot 780€ abgegeben.' },
        { id:'i_'+randHex(6), created: now-7200000, url:'https://www.ebay.de/itm/Apple-iPhone-13/10000001', title:'iPhone 13 128GB Midnight – OVP', platform:'eBay', buy:380, sell:520, feePct:11, ship:5.49, status:'kontaktiert', due:'', tags:'iphone, 128gb', note:'Leichte Kratzer, Akku 87%.' },
        { id:'i_'+randHex(6), created: now-17200000, url:'https://www.kleinanzeigen.de/s-anzeige/dyson-v11/2222222', title:'Dyson V11 – Zubehör komplett', platform:'Kleinanzeigen', buy:120, sell:230, feePct:0, ship:0, status:'verkauft', due:'', tags:'haushalt', note:'Schon verkauft an Max. Abholung erledigt.' }
      ];
      writeData(email, data);
    }

    // ===== Init =====
    (async function init(){
      if(CLOUD){ await attachCloudAuth(); const { data } = await sb.auth.getSession(); if(data?.session){ const email = data.session.user.email; currentUser = email; setSession(email); $('#userEmail').textContent = email; $('#authView').classList.add('hidden'); $('#appView').classList.remove('hidden'); await syncDown(); renderList(); recalcStats(); return; } }
      await attachLocalAuth();
      const sess = getSession(); if(sess && readUsers()[sess]){ currentUser = sess; $('#userEmail').textContent = sess; $('#authView').classList.add('hidden'); $('#appView').classList.remove('hidden'); if(!(readData(sess)?.items?.length)) seedSamples(); renderList(); }
    })();
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ResellDeck — Futuristisches Reseller-Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/@tabler/icons-webfont@latest/tabler-icons.min.css">
  <style>
    :root {
      --bg: #0b0f1a;
      --card: rgba(16, 20, 35, 0.72);
      --muted: #9aa4bf;
      --text: #e8edff;
      --accent: #7c4dff;
      --accent2: #00e5ff;
      --ok: #00d48a;
      --warn: #ffb020;
      --danger: #ff4d67;
      --glass: blur(14px) saturate(130%);
      --radius: 18px;
      --shadow: 0 10px 35px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
      --gradient: radial-gradient(1000px 600px at 0% -10%, rgba(124,77,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 100% 110%, rgba(0,229,255,.18), transparent 60%),
                  linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0; background: var(--bg); color: var(--text); font-family: 'Space Grotesk', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      background-image: var(--gradient);
      background-attachment: fixed; 
    }

    a { color: var(--accent2); text-decoration: none }
    a:hover { text-decoration: underline }

    .container { max-width: 1200px; margin: 0 auto; padding: 28px; }

    .brand { display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.5px; }
    .brand .logo { width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, var(--accent), var(--accent2)); position: relative; box-shadow: 0 8px 28px rgba(124,77,255,.35), 0 8px 28px rgba(0,229,255,.25); }
    .brand .logo::after { content: ""; position: absolute; inset: 8px; border-radius: 9px; background: rgba(255,255,255,.2); filter: blur(6px); }

    .card { background: var(--card); backdrop-filter: var(--glass); border-radius: var(--radius); box-shadow: var(--shadow); }
    .card.pad { padding: 18px; }
    .row { display:flex; gap: 18px; flex-wrap: wrap }

    header.app { display:flex; align-items:center; justify-content:space-between; gap: 16px; padding: 18px 24px; position: sticky; top: 0; z-index: 5; background: linear-gradient(180deg, rgba(11,15,26,.88), rgba(11,15,26,.55) 60%, rgba(11,15,26,0)); border-bottom: 1px solid rgba(255,255,255,.06); }

    .chip { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius: 999px; background: rgba(255,255,255,.06); color: var(--muted); font-size: 12px; }

    input, select, textarea, button { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); color: var(--text); border-radius: 12px; padding: 12px 12px; outline: none; width: 100%; font: inherit; }
    input::placeholder, textarea::placeholder { color: #b9c3e4aa }
    label { font-size: 12px; color: var(--muted); margin-bottom: 8px; display:block }

    .btn { cursor: pointer; user-select: none; transition: .25s ease; border-radius: 12px; }
    .btn.primary { background: linear-gradient(135deg, var(--accent), var(--accent2)); border: none; color: #0a0e18; font-weight: 700; }
    .btn.ghost { background: transparent; border: 1px dashed rgba(255,255,255,.18); }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.05) }

    .auth-wrap { min-height: 100vh; display:grid; place-items:center; padding: 28px }
    .auth { max-width: 880px; width: 100%; display:grid; grid-template-columns: 1.2fr 1fr; overflow: hidden }
    .auth .left { padding: 28px; position:relative }
    .auth .right { padding: 28px; background: linear-gradient(160deg, rgba(124,77,255,.2), rgba(0,229,255,.12)); }
    .auth h1 { margin: 0 0 8px 0; }
    .auth p { margin: 0; color: var(--muted) }
    .auth .tabbar { display:flex; gap:8px; margin: 18px 0 12px }
    .auth .tabbar button { flex:1; padding: 10px 12px }

    form.grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px }
    form.grid .span2 { grid-column: 1 / -1 }

    .hidden { display:none !important }

    /* Dashboard */
    .layout { display:grid; grid-template-columns: 300px 1fr; gap: 18px; }
    @media (max-width: 960px) { .layout { grid-template-columns: 1fr } }

    .searchbar { display:flex; align-items:center; gap:12px; flex:1 }
    .searchbar input { width: 100% }

    .stats { display:grid; grid-template-columns: repeat(4, 1fr); gap: 14px }
    @media (max-width: 960px) { .stats { grid-template-columns: repeat(2, 1fr) } }
    .stat { padding:16px; position:relative; overflow:hidden }
    .stat .label { color: var(--muted); font-size: 12px }
    .stat .value { font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 22px; margin-top:6px }
    .stat .glow { position:absolute; inset: -1px; border-radius: var(--radius); pointer-events:none; box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }

    .list { display:grid; gap: 12px }

    .item { display:grid; grid-template-columns: 1fr 160px 140px 110px 90px 40px; gap: 10px; align-items:center; padding: 10px 12px; }
    .item .title { font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .item .url { font-size:12px; color: var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .item .platform { font-size:12px; }
    .item .badge { padding:6px 10px; border-radius: 999px; font-size:12px; display:inline-flex; align-items:center; gap:6px }
    .badge.sourced { background: rgba(124,77,255,.18); color: #cbb6ff }
    .badge.contacted { background: rgba(0,229,255,.18); color: #a9f6ff }
    .badge.negotiating { background: rgba(255,176,32,.18); color: #ffd391 }
    .badge.bought { background: rgba(0,212,138,.18); color: #a6ffd9 }
    .badge.listed { background: rgba(255,255,255,.08); color: #dfe7ff }
    .badge.sold { background: rgba(0,212,138,.25); color: #7effc7; border: 1px solid rgba(0,212,138,.35) }

    .actions { display:flex; gap:8px; justify-content:flex-end }
    .iconbtn { width:36px; height:36px; display:grid; place-items:center; border-radius: 10px; border: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.04); cursor: pointer }
    .iconbtn:hover { filter: brightness(1.1) }

    .subtle { color: var(--muted); font-size: 12px }

    .footer { margin-top: 24px; display:flex; gap:12px; flex-wrap:wrap; justify-content: space-between; align-items:center }

    .divider { height:1px; background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.12), rgba(255,255,255,0)); margin: 14px 0 }

    .template { background: rgba(255,255,255,.05); padding: 12px; border-radius: 12px; border: 1px dashed rgba(255,255,255,.12) }
    .template .row { align-items:center }

    .modal { position: fixed; inset: 0; display:none; place-items:center; background: rgba(3,6,10,.6); z-index: 20 }
    .modal .dialog { max-width: 520px; width: calc(100% - 36px); }
    .modal.show { display:grid }

    .kicker { font-size:12px; color: var(--muted); text-transform: uppercase; letter-spacing: .14em }

    .taglist { display:flex; gap:8px; flex-wrap: wrap }
    .tag { background: rgba(255,255,255,.08); padding: 6px 10px; border-radius: 999px; font-size: 12px }

    .pill { border-radius: 999px; padding: 6px 10px; background: rgba(255,255,255,.06); font-size:12px }

    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px }
    @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr } }

    .note { font-size: 12px; color: var(--muted) }

    .comingsoon { opacity: .75; pointer-events: none }
  </style>
</head>
<body>
  <header class="app">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div>ResellDeck</div>
        <div class="subtle">Kleinanzeigen & eBay Workflow, aber hübsch ✨</div>
      </div>
    </div>
    <div class="searchbar">
      <i class="ti ti-search"></i>
      <input id="search" placeholder="Suche Links, Titel, Tags… (Strg+/)" />
    </div>
    <div class="chip" id="userChip"><i class="ti ti-user"></i><span id="userEmail">Gast</span></div>
    <button class="btn ghost" id="logoutBtn"><i class="ti ti-logout"></i>&nbsp;Logout</button>
  </header>

  <div id="authView" class="auth-wrap">
    <div class="auth card">
      <div class="left">
        <div class="brand" style="margin-bottom:12px">
          <div class="logo" style="width:32px;height:32px"></div>
          <div>ResellDeck</div>
        </div>
        <h1>Dein futuristisches Reseller-Dashboard</h1>
        <p>
          Speichere Links, behalte Deals im Blick, nutze Vorlagen – alles im Browser. <strong>Demo-Login</strong> ohne Server, Daten liegen nur in <em>deinem</em> Browser.
          <br><span class="note">Optionaler Cloud‑Sync via Supabase ist im Code vorbereitet (siehe Hinweis rechts).</span>
        </p>
        <div class="divider"></div>
        <div class="tabbar">
          <button id="tabLogin" class="btn">Login</button>
          <button id="tabRegister" class="btn ghost">Account erstellen</button>
        </div>
        <form id="loginForm" class="grid">
          <div class="span2">
            <label>E-Mail</label>
            <input required type="email" id="loginEmail" placeholder="du@beispiel.de" autocomplete="username" />
          </div>
          <div class="span2">
            <label>Passwort</label>
            <input required type="password" id="loginPassword" placeholder="••••••••" autocomplete="current-password" />
          </div>
          <div class="span2">
            <button class="btn primary" type="submit">Einloggen</button>
          </div>
        </form>

        <form id="registerForm" class="grid hidden">
          <div class="span2">
            <label>E-Mail</label>
            <input required type="email" id="regEmail" placeholder="du@beispiel.de" autocomplete="username" />
          </div>
          <div>
            <label>Passwort</label>
            <input required type="password" id="regPassword" placeholder="mind. 8 Zeichen" autocomplete="new-password" />
          </div>
          <div>
            <label>Passwort (Wiederholen)</label>
            <input required type="password" id="regPassword2" placeholder="nochmal" autocomplete="new-password" />
          </div>
          <div class="span2">
            <button class="btn primary" type="submit">Account erstellen</button>
          </div>
          <p class="note span2">Hinweis: Client-Login (LocalStorage) oder 
            <span class="pill">Supabase‑Auth</span> wenn konfiguriert.</p>
        </form>
      </div>
      <div class="right">
        <div class="kicker">Features</div>
        <ul>
          <li>🔗 Link-Speicher mit Status-Workflow</li>
          <li>💬 Verhandlungs-Vorlagen & Copy-Buttons</li>
          <li>📈 Profit-Rechner & Mini-Statistiken</li>
          <li>⏰ Erinnerungen/Deadlines pro Deal</li>
          <li>⬇️ Export/⬆️ Import als JSON</li>
          <li>🤖 <em>Coming Soon:</em> AI-Listing-Optimierer</li>
        </ul>
        <div class="divider"></div>
        <div class="kicker">Cloud‑Sync (optional)</div>
        <p class="note">
          Trage in der <code>&lt;script type="module"&gt;</code>-Sektion deine 
          <strong>SUPABASE_URL</strong> &amp; <strong>SUPABASE_ANON_KEY</strong> ein.
          Danach ist Login/Sync automatisch online.
        </p>
        <div class="divider"></div>
        <div class="kicker">Demo-Zugang</div>
        <p class="note">Du kannst dir einfach selbst einen Account anlegen. Alternativ: <code class="pill">demo@deck.dev</code> / <code class="pill">demo1234</code> (lokal).</p>
      </div>
    </div>
  </div>

  <main id="appView" class="container hidden">
    <div class="stats">
      <div class="card stat"><div class="glow"></div><div class="label">Gespeicherte Links</div><div id="statTotal" class="value">0</div></div>
      <div class="card stat"><div class="glow"></div><div class="label">Aktiv (Kontakt/Laufend)</div><div id="statActive" class="value">0</div></div>
      <div class="card stat"><div class="glow"></div><div class="label">Gewinn (prognostiziert)</div><div id="statProfit" class="value">€0</div></div>
      <div class="card stat"><div class="glow"></div><div class="label">Fällige Erinnerungen</div><div id="statDue" class="value">0</div></div>
    </div>

    <div class="layout" style="margin-top:18px">
      <aside class="card pad">
        <h3 style="margin-top:0">Link speichern</h3>
        <form id="addForm">
          <label>URL</label>
          <input id="fUrl" type="url" placeholder="https://www.kleinanzeigen.de/... oder https://www.ebay.de/..." required />
          <div class="grid-2" style="margin-top:12px">
            <div>
              <label>Titel</label>
              <input id="fTitle" placeholder="z.B. iPhone 13, sehr guter Zustand" />
            </div>
            <div>
              <label>Plattform</label>
              <select id="fPlatform">
                <option>Automatisch</option>
                <option>eBay</option>
                <option>Kleinanzeigen</option>
                <option>Sonstiges</option>
              </select>
            </div>
          </div>
          <div class="grid-2" style="margin-top:12px">
            <div>
              <label>Einkaufspreis (Ziel)</label>
              <input id="fBuy" type="number" inputmode="decimal" placeholder="€" />
            </div>
            <div>
              <label>Verkaufspreis (Ziel)</label>
              <input id="fSell" type="number" inputmode="decimal" placeholder="€" />
            </div>
          </div>
          <div class="grid-2" style="margin-top:12px">
            <div>
              <label>Status</label>
              <select id="fStatus">
                <option>gesichtet</option>
                <option>kontaktiert</option>
                <option>verhandlung</option>
                <option>gekauft</option>
                <option>gelistet</option>
                <option>verkauft</option>
              </select>
            </div>
            <div>
              <label>Erinnerung</label>
              <input id="fDue" type="date" />
            </div>
          </div>
          <label style="margin-top:12px">Tags (Komma-getrennt)</label>
          <input id="fTags" placeholder="iphone, 128gb, spacegray" />
          <label style="margin-top:12px">Notiz</label>
          <textarea id="fNote" rows="3" placeholder="Zustand, Standort, Argumente…"></textarea>
          <button class="btn primary" style="margin-top:14px" type="submit"><i class="ti ti-bookmark-plus"></i>&nbsp;Speichern</button>
        </form>

        <div class="divider"></div>
        <div>
          <h3 style="margin:0 0 8px 0">Vorlagen (Copy & Paste)</h3>
          <div class="template">
            <div class="row">
              <div style="flex:1">
                <div class="kicker">Erstkontakt</div>
                <p class="note" style="margin:4px 0 8px">Höfliche Anfrage mit Preisanker</p>
              </div>
              <button class="btn ghost" id="copyTpl1"><i class="ti ti-copy"></i>&nbsp;Kopieren</button>
            </div>
            <pre id="tpl1" class="subtle" style="white-space:pre-wrap; user-select:all;">Hi! 😊 Ist der Artikel noch verfügbar? Würde heute abholen/zzgl. Versand nehmen. Wenn  <Zielpreis>  für dich passt, bin ich sofort dabei. Danke dir!</pre>
          </div>
          <div class="template" style="margin-top:10px">
            <div class="row">
              <div style="flex:1">
                <div class="kicker">Gegenangebot</div>
                <p class="note" style="margin:4px 0 8px">Kurz & freundlich</p>
              </div>
              <button class="btn ghost" id="copyTpl2"><i class="ti ti-copy"></i>&nbsp;Kopieren</button>
            </div>
            <pre id="tpl2" class="subtle" style="white-space:pre-wrap; user-select:all;">Danke fürs schnelle Feedback! Ich könnte  <MeinPreis>  anbieten und heute/sofort zahlen. Deal?</pre>
          </div>

          <div class="divider"></div>
          <h3 style="margin:0 0 8px 0">Export & Import</h3>
          <div class="row">
            <button class="btn ghost" id="exportBtn"><i class="ti ti-download"></i>&nbsp;Daten exportieren (JSON)</button>
            <label class="btn ghost" style="cursor:pointer"><i class="ti ti-upload"></i>&nbsp;Importieren<input id="importFile" type="file" accept="application/json" style="display:none"></label>
          </div>
          <p class="note" style="margin-top:8px">Sichert deine Links in eine Datei oder importiert sie später wieder.</p>

          <div class="divider"></div>
          <button class="btn" id="wipeBtn" style="width:100%; background: rgba(255,77,103,.1); border:1px solid rgba(255,77,103,.35); color:#ffcfda"><i class="ti ti-alert-triangle"></i>&nbsp;Lokale Daten löschen</button>
        </div>
      </aside>

      <section class="card pad">
        <div class="row" style="align-items:center; justify-content:space-between">
          <h3 style="margin:0">Deine Deals</h3>
          <div class="row" style="align-items:center">
            <select id="filterStatus">
              <option value="">Alle Status</option>
              <option value="gesichtet">Gesichtet</option>
              <option value="kontaktiert">Kontaktiert</option>
              <option value="verhandlung">Verhandlung</option>
              <option value="gekauft">Gekauft</option>
              <option value="gelistet">Gelistet</option>
              <option value="verkauft">Verkauft</option>
            </select>
            <select id="sortBy">
              <option value="createdDesc">Neueste zuerst</option>
              <option value="profitDesc">Höchster Profit</option>
              <option value="dueAsc">Nächste Fälligkeit</option>
              <option value="titleAsc">Titel A→Z</option>
            </select>
          </div>
        </div>
        <div class="list" id="list"></div>
      </section>
    </div>

    <div class="footer">
      <div class="subtle">💡 Tipp: Zieh die URL per Copy/Paste rein. Mit <strong>Strg+/</strong> öffnest du die Suche.</div>
      <div class="chip comingsoon"><i class="ti ti-sparkles"></i> AI-Listing-Optimierer – bald™️</div>
    </div>
  </main>

  <div id="profitModal" class="modal">
    <div class="dialog card pad">
      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
        <h3 style="margin:0">Profit-Rechner</h3>
        <button class="iconbtn" id="profitClose"><i class="ti ti-x"></i></button>
      </div>
      <div class="grid-2">
        <div>
          <label>Einkaufspreis</label>
          <input id="pmBuy" type="number" inputmode="decimal" />
        </div>
        <div>
          <label>Verkaufspreis</label>
          <input id="pmSell" type="number" inputmode="decimal" />
        </div>
        <div>
          <label>Plattformgebühren (%)</label>
          <input id="pmFeePct" type="number" inputmode="decimal" value="11" />
        </div>
        <div>
          <label>Versandkosten</label>
          <input id="pmShip" type="number" inputmode="decimal" value="0" />
        </div>
      </div>
      <div class="divider"></div>
      <div class="row" style="align-items:center; justify-content:space-between">
        <div>
          <div class="kicker">Prognose</div>
          <div id="pmResult" style="font-family:'JetBrains Mono', ui-monospace; font-size:20px">€0</div>
        </div>
        <button class="btn primary" id="pmApply"><i class="ti ti-check"></i>&nbsp;In Deal übernehmen</button>
      </div>
    </div>
  </div>

  <template id="itemTmpl">
    <div class="item card">
      <div>
        <div class="title"></div>
        <div class="url"></div>
      </div>
      <div class="platform"></div>
      <div class="status"></div>
      <div class="profit" style="font-family:'JetBrains Mono', ui-monospace">€0</div>
      <div class="due subtle">–</div>
      <div class="actions">
        <button class="iconbtn open"><i class="ti ti-external-link"></i></button>
        <button class="iconbtn edit"><i class="ti ti-pencil"></i></button>
        <button class="iconbtn calc"><i class="ti ti-calculator"></i></button>
        <button class="iconbtn del" title="Löschen" style="border-color: rgba(255,77,103,.35)"><i class="ti ti-trash"></i></button>
      </div>
    </div>
  </template>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // ===== Supabase Config (optional – für Cloud‑Sync) =====
    // Trage hier deine Werte ein, um die Online‑Funktionen zu aktivieren
    const SUPABASE_URL = '';
    const SUPABASE_ANON_KEY = '';
    const CLOUD = !!(SUPABASE_URL && SUPABASE_ANON_KEY);
    const sb = CLOUD ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

    // ===== Utilities =====
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
    const fmtMoney = (n) => `€${Number(n||0).toLocaleString('de-DE', {maximumFractionDigits: 2})}`;
    const todayISO = () => new Date().toISOString().slice(0,10);

    // Password hashing (client-side demo only – für lokalen Modus)
    async function sha256Hex(str){
      const enc = new TextEncoder();
      const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    const randHex = (len=16) => [...crypto.getRandomValues(new Uint8Array(len))].map(x=>x.toString(16).padStart(2,'0')).join('');

    // Storage (Local Mode)
    const USERS_KEY = 'rd_users_v1';
    const SESSION_KEY = 'rd_session_v1';
    function readUsers(){ try { return JSON.parse(localStorage.getItem(USERS_KEY) || '{}') } catch { return {} } }
    function writeUsers(obj){ localStorage.setItem(USERS_KEY, JSON.stringify(obj)) }

    function dataKey(email){ return `rd_data_${email}` }
    function readData(email){ try { return JSON.parse(localStorage.getItem(dataKey(email)) || '{}') } catch { return {} } }
    function writeData(email, obj){ localStorage.setItem(dataKey(email), JSON.stringify(obj)) }

    function defaultData(){
      return {
        items: [],
        templates: {
          first: $('#tpl1').textContent.trim(),
          counter: $('#tpl2').textContent.trim()
        },
        settings: { feePct: 11 }
      }
    }

    // Auth State
    let currentUser = null; // email (lokal) oder Supabase-Email
    function setSession(email){ if(email){ localStorage.setItem(SESSION_KEY, email); } else { localStorage.removeItem(SESSION_KEY) } }
    function getSession(){ return localStorage.getItem(SESSION_KEY) }

    function platformFromUrl(u){
      try {
        const h = new URL(u).hostname;
        if(/kleinanzeigen\.de|ebay-kleinanzeigen\.de/i.test(h)) return 'Kleinanzeigen';
        if(/ebay\./i.test(h)) return 'eBay';
      } catch {}
      return 'Sonstiges';
    }

    function statusBadge(s){
      const map = { gesichtet:'sourced', kontaktiert:'contacted', verhandlung:'negotiating', gekauft:'bought', gelistet:'listed', verkauft:'sold' };
      const cls = map[s] || 'sourced';
      const span = document.createElement('span');
      span.className = `badge ${cls}`;
      span.textContent = s.charAt(0).toUpperCase()+s.slice(1);
      return span;
    }

    function computeProfit(it, feePctFallback=11){
      const buy = Number(it.buy || 0);
      const sell = Number(it.sell || 0);
      const feePct = Number(typeof it.feePct === 'number' ? it.feePct : feePctFallback);
      const fees = sell * (feePct/100);
      const ship = Number(it.ship || 0);
      return Math.round((sell - fees - ship - buy) * 100) / 100;
    }

    function recalcStats(){
      const data = readData(currentUser) || defaultData();
      const items = data.items || [];
      $('#statTotal').textContent = items.length;
      $('#statActive').textContent = items.filter(i=>['kontaktiert','verhandlung','gelistet'].includes(i.status)).length;
      const profit = items.reduce((sum,i)=> sum + (i.status==='verkauft' || i.sell ? computeProfit(i, data.settings.feePct) : 0), 0);
      $('#statProfit').textContent = fmtMoney(profit);
      const due = items.filter(i=> i.due && i.due <= todayISO()).length;
      $('#statDue').textContent = due;
    }

    function renderList(){
      const data = readData(currentUser) || defaultData();
      const q = $('#search').value.trim().toLowerCase();
      const fStatus = $('#filterStatus').value;
      const sortBy = $('#sortBy').value;
      let items = [...(data.items||[])];
      // filter
      if(q){ items = items.filter(i=> (i.title||'').toLowerCase().includes(q) || (i.url||'').toLowerCase().includes(q) || (i.tags||'').toLowerCase().includes(q)) }
      if(fStatus){ items = items.filter(i=> i.status === fStatus) }
      // sort
      items.sort((a,b)=>{
        switch(sortBy){
          case 'profitDesc': return computeProfit(b, data.settings.feePct) - computeProfit(a, data.settings.feePct);
          case 'dueAsc': return (a.due||'9999-12-31').localeCompare(b.due||'9999-12-31');
          case 'titleAsc': return (a.title||'').localeCompare(b.title||'');
          default: return (b.created||0) - (a.created||0);
        }
      });

      const list = $('#list');
      list.innerHTML = '';
      const tmpl = $('#itemTmpl');
      for(const it of items){
        const row = tmpl.content.firstElementChild.cloneNode(true);
        $('.title', row).textContent = it.title || '(ohne Titel)';
        $('.url', row).textContent = it.url;
        const plat = $('.platform', row);
        plat.innerHTML = `<span class="chip"><i class="ti ti-brand-${it.platform==='eBay'?'ebay':'cash'}"></i>${it.platform}</span>`;
        const st = $('.status', row);
        st.innerHTML = '';
        st.appendChild(statusBadge(it.status || 'gesichtet'));
        $('.profit', row).textContent = fmtMoney(computeProfit(it, data.settings.feePct));
        $('.due', row).innerHTML = it.due ? (it.due <= todayISO() ? `<span style="color:var(--warn)">${it.due}</span>` : it.due) : '–';

        $('.open', row).addEventListener('click', ()=> window.open(it.url, '_blank'));
        $('.del', row).addEventListener('click', ()=> onDelete(it.id));
        $('.edit', row).addEventListener('click', ()=> editItem(it.id));
        $('.calc', row).addEventListener('click', ()=> openProfit(it.id));

        list.appendChild(row);
      }

      recalcStats();
    }

    function editItem(id){
      const data = readData(currentUser) || defaultData();
      const it = data.items.find(x=>x.id===id);
      if(!it) return;
      // Pre-fill the add form for quick editing
      $('#fUrl').value = it.url || '';
      $('#fTitle').value = it.title || '';
      $('#fPlatform').value = ['eBay','Kleinanzeigen','Sonstiges'].includes(it.platform) ? it.platform : 'Automatisch';
      $('#fBuy').value = it.buy || '';
      $('#fSell').value = it.sell || '';
      $('#fStatus').value = it.status || 'gesichtet';
      $('#fDue').value = it.due || '';
      $('#fTags').value = it.tags || '';
      $('#fNote').value = it.note || '';
      $('#addForm').dataset.editing = id;
      $('#addForm').querySelector('button[type="submit"]').innerHTML = '<i class="ti ti-device-floppy"></i>&nbsp;Änderungen speichern';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Profit modal
    let profitContextId = null;
    function openProfit(id){
      const data = readData(currentUser) || defaultData();
      const it = data.items.find(x=>x.id===id);
      profitContextId = id;
      $('#pmBuy').value = it?.buy || '';
      $('#pmSell').value = it?.sell || '';
      $('#pmFeePct').value = typeof it?.feePct === 'number' ? it.feePct : (data.settings.feePct||11);
      $('#pmShip').value = it?.ship || 0;
      updateProfitResult();
      $('#profitModal').classList.add('show');
    }
    function updateProfitResult(){
      const buy = Number($('#pmBuy').value||0);
      const sell = Number($('#pmSell').value||0);
      const feePct = Number($('#pmFeePct').value||0);
      const ship = Number($('#pmShip').value||0);
      const fees = sell * (feePct/100);
      const p = Math.round((sell - fees - ship - buy) * 100) / 100;
      $('#pmResult').textContent = fmtMoney(p);
    }

    // Events for profit modal
    ['pmBuy','pmSell','pmFeePct','pmShip'].forEach(id=> $('#'+id).addEventListener('input', updateProfitResult));
    $('#profitClose').addEventListener('click', ()=> $('#profitModal').classList.remove('show'));
    $('#pmApply').addEventListener('click', ()=>{
      const data = readData(currentUser) || defaultData();
      const it = data.items.find(x=>x.id===profitContextId);
      if(!it) return;
      it.buy = Number($('#pmBuy').value||0);
      it.sell = Number($('#pmSell').value||0);
      it.feePct = Number($('#pmFeePct').value||0);
      it.ship = Number($('#pmShip').value||0);
      writeData(currentUser, data);
      syncUpOne(it).catch(()=>{});
      $('#profitModal').classList.remove('show');
      renderList();
    });

    // ===== Auth UI switching =====
    const loginForm = $('#loginForm');
    const registerForm = $('#registerForm');
    const tabLogin = $('#tabLogin');
    const tabRegister = $('#tabRegister');

    tabLogin.addEventListener('click', ()=>{ registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); tabLogin.classList.remove('ghost'); tabRegister.classList.add('ghost'); });
    tabRegister.addEventListener('click', ()=>{ loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); tabRegister.classList.remove('ghost'); tabLogin.classList.add('ghost'); });

    // ===== Local Auth (Fallback) =====
    async function attachLocalAuth(){
      registerForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = $('#regEmail').value.trim().toLowerCase();
        const pw = $('#regPassword').value;
        const pw2 = $('#regPassword2').value;
        if(pw.length < 8) return alert('Passwort zu kurz (min. 8 Zeichen).');
        if(pw !== pw2) return alert('Passwörter stimmen nicht überein.');
        const users = readUsers();
        if(users[email]) return alert('E-Mail bereits registriert.');
        const salt = randHex(16);
        const hash = await sha256Hex(pw + ':' + salt);
        users[email] = { salt, hash, created: Date.now() };
        writeUsers(users);
        writeData(email, defaultData());
        alert('Account erstellt! Du kannst dich jetzt einloggen.');
        tabLogin.click();
      });

      loginForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = $('#loginEmail').value.trim().toLowerCase();
        const pw = $('#loginPassword').value;
        const users = readUsers();
        const u = users[email];
        if(!u) return alert('Unbekannte E-Mail. Bitte registrieren.');
        const hash = await sha256Hex(pw + ':' + u.salt);
        if(hash !== u.hash) return alert('Falsches Passwort.');
        currentUser = email;
        setSession(email);
        $('#userEmail').textContent = email;
        $('#authView').classList.add('hidden');
        $('#appView').classList.remove('hidden');
        if(!(readData(email)?.items?.length)) seedSamples();
        renderList();
        recalcStats();
      });

      $('#logoutBtn').addEventListener('click', ()=>{ currentUser=null; setSession(null); $('#appView').classList.add('hidden'); $('#authView').classList.remove('hidden'); $('#loginEmail').focus(); });
      $('#wipeBtn').addEventListener('click', ()=>{ if(!currentUser) return; if(confirm('Wirklich lokale Daten löschen?')){ const users = readUsers(); delete users[currentUser]; writeUsers(users); localStorage.removeItem(dataKey(currentUser)); setSession(null); currentUser=null; location.reload(); }});
    }

    // ===== Cloud Auth (Supabase) =====
    async function attachCloudAuth(){
      // Registrierung in Supabase (evtl. E-Mail-Bestätigung in Auth-Einstellungen deaktivieren)
      registerForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = $('#regEmail').value.trim().toLowerCase();
        const password = $('#regPassword').value;
        const pw2 = $('#regPassword2').value;
        if(password.length < 8) return alert('Passwort zu kurz (min. 8 Zeichen).');
        if(password !== pw2) return alert('Passwörter stimmen nicht überein.');
        const { error } = await sb.auth.signUp({ email, password });
        if(error) return alert(error.message);
        alert('Account erstellt! Prüfe ggf. dein Postfach (Bestätigung).');
        tabLogin.click();
      });

      loginForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = $('#loginEmail').value.trim().toLowerCase();
        const password = $('#loginPassword').value;
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if(error) return alert(error.message);
        const user = data.user;
        currentUser = user.email;
        setSession(currentUser);
        $('#userEmail').textContent = currentUser;
        $('#authView').classList.add('hidden');
        $('#appView').classList.remove('hidden');
        await syncDown();
        renderList();
        recalcStats();
      });

      $('#logoutBtn').addEventListener('click', async ()=>{ await sb.auth.signOut(); currentUser=null; setSession(null); $('#appView').classList.add('hidden'); $('#authView').classList.remove('hidden'); $('#loginEmail').focus(); });
      $('#wipeBtn').addEventListener('click', ()=>{ if(!currentUser) return; if(confirm('Nur der lokale Cache wird gelöscht. (Cloud-Daten bleiben bestehen)')){ localStorage.removeItem(dataKey(currentUser)); location.reload(); }});
    }

    // ===== CRUD Hooks (lokal + optional Cloud-Upserts) =====
    async function onDelete(id){
      const data = readData(currentUser) || defaultData();
      if(confirm('Diesen Eintrag löschen?')){
        const it = data.items.find(x=>x.id===id);
        data.items = data.items.filter(x=>x.id!==id);
        writeData(currentUser, data);
        renderList();
        recalcStats();
        if(CLOUD) { try { await sb.from('deals').delete().eq('id', id); } catch{} }
      }
    }

    async function syncUpOne(it){
      if(!CLOUD) return;
      try {
        const { data: u } = await sb.auth.getUser();
        const row = toRow(it, u?.user?.id);
        await sb.from('deals').upsert(row);
      } catch {}
    }

    async function syncDown(){
      if(!CLOUD) return;
      const { data: rows, error } = await sb.from('deals').select('*').order('created', { ascending: false });
      if(error){ console.warn(error); return; }
      const email = (await sb.auth.getUser()).data.user.email;
      currentUser = email; setSession(email); $('#userEmail').textContent = email;
      const data = readData(email) || defaultData();
      data.items = (rows||[]).map(fromRow);
      writeData(email, data);
    }

    function toRow(it, userId){
      return {
        id: it.id,
        user_id: userId,
        created: it.created || Date.now(),
        url: it.url || null,
        title: it.title || null,
        platform: it.platform || null,
        buy: it.buy ?? null,
        sell: it.sell ?? null,
        fee_pct: (typeof it.feePct==='number'? it.feePct : null),
        ship: it.ship ?? null,
        status: it.status || null,
        due: it.due || null,
        tags: it.tags || null,
        note: it.note || null
      };
    }
    function fromRow(r){
      return {
        id: r.id,
        created: r.created,
        url: r.url,
        title: r.title,
        platform: r.platform||'Sonstiges',
        buy: Number(r.buy ?? 0),
        sell: Number(r.sell ?? 0),
        feePct: typeof r.fee_pct==='number'? r.fee_pct : undefined,
        ship: Number(r.ship ?? 0),
        status: r.status||'gesichtet',
        due: r.due || '',
        tags: r.tags || '',
        note: r.note || ''
      };
    }

    // ===== Add / Update item (Form) =====
    $('#addForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = readData(currentUser) || defaultData();
      const editingId = e.currentTarget.dataset.editing || null;

      const url = $('#fUrl').value.trim();
      const title = $('#fTitle').value.trim();
      let platform = $('#fPlatform').value;
      if(platform === 'Automatisch') platform = platformFromUrl(url);
      const buy = Number($('#fBuy').value || 0);
      const sell = Number($('#fSell').value || 0);
      const status = $('#fStatus').value;
      const due = $('#fDue').value || '';
      const tags = $('#fTags').value.trim();
      const note = $('#fNote').value.trim();

      if(editingId){
        const it = data.items.find(x=>x.id===editingId);
        if(!it) return;
        Object.assign(it, { url, title, platform, buy, sell, status, due, tags, note });
        e.currentTarget.dataset.editing = '';
        e.currentTarget.querySelector('button[type="submit"]').innerHTML = '<i class="ti ti-bookmark-plus"></i>&nbsp;Speichern';
        writeData(currentUser, data);
        await syncUpOne(it);
      } else {
        const it = { id: 'i_'+randHex(8), created: Date.now(), url, title, platform, buy, sell, status, due, tags, note, ship: 0 };
        data.items.unshift(it);
        writeData(currentUser, data);
        await syncUpOne(it);
      }

      e.currentTarget.reset();
      renderList();
    });

    // Search & filters
    $('#search').addEventListener('input', renderList);
    $('#filterStatus').addEventListener('change', renderList);
    $('#sortBy').addEventListener('change', renderList);
    window.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.key === '/') { e.preventDefault(); $('#search').focus() } });

    // Copy templates
    $('#copyTpl1').addEventListener('click', ()=>copyText($('#tpl1').textContent));
    $('#copyTpl2').addEventListener('click', ()=>copyText($('#tpl2').textContent));
    async function copyText(t){ try { await navigator.clipboard.writeText(t); alert('Vorlage kopiert!') } catch { prompt('Kopiere manuell:', t) } }

    // Export / Import (arbeitet auf dem lokalen Cache; in Cloud‑Modus kannst du danach hochladen via Sync)
    $('#exportBtn').addEventListener('click', ()=>{
      if(!currentUser) return;
      const data = readData(currentUser) || defaultData();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `reselldeck_${currentUser.replace(/[^a-z0-9]/gi,'_')}.json`; a.click(); URL.revokeObjectURL(a.href);
    });
    $('#importFile').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const txt = await file.text();
      try {
        const obj = JSON.parse(txt);
        const data = readData(currentUser) || defaultData();
        data.items = Array.isArray(obj.items) ? obj.items : data.items;
        data.templates = obj.templates || data.templates;
        data.settings = obj.settings || data.settings;
        writeData(currentUser, data);
        renderList();
        alert('Import erfolgreich.');
        if(CLOUD){ // optional hochladen
          for(const it of data.items){ await syncUpOne(it); }
        }
      } catch(err){ alert('Import fehlgeschlagen: ' + err.message); }
      e.target.value = '';
    });

    // Seed sample data (nur wenn lokal neu)
    function seedSamples(){
      const email = currentUser; const data = readData(email) || defaultData(); if((data.items||[]).length) return;
      const now = Date.now();
      data.items = [
        { id:'i_'+randHex(6), created: now-300000, url:'https://www.kleinanzeigen.de/s-anzeige/sony-a7-iii-kit/1234567890', title:'Sony A7 III (Kit) – Top Zustand', platform:'Kleinanzeigen', buy:750, sell:1050, feePct:0, ship:0, status:'verhandlung', due: todayISO(), tags:'kamera, sony, vollformat', note:'Mit 2 Akkus, 24-70mm. Angebot 780€ abgegeben.' },
        { id:'i_'+randHex(6), created: now-7200000, url:'https://www.ebay.de/itm/Apple-iPhone-13/10000001', title:'iPhone 13 128GB Midnight – OVP', platform:'eBay', buy:380, sell:520, feePct:11, ship:5.49, status:'kontaktiert', due:'', tags:'iphone, 128gb', note:'Leichte Kratzer, Akku 87%.' },
        { id:'i_'+randHex(6), created: now-17200000, url:'https://www.kleinanzeigen.de/s-anzeige/dyson-v11/2222222', title:'Dyson V11 – Zubehör komplett', platform:'Kleinanzeigen', buy:120, sell:230, feePct:0, ship:0, status:'verkauft', due:'', tags:'haushalt', note:'Schon verkauft an Max. Abholung erledigt.' }
      ];
      writeData(email, data);
    }

    // ===== Init =====
    (async function init(){
      if(CLOUD){ await attachCloudAuth(); const { data } = await sb.auth.getSession(); if(data?.session){ const email = data.session.user.email; currentUser = email; setSession(email); $('#userEmail').textContent = email; $('#authView').classList.add('hidden'); $('#appView').classList.remove('hidden'); await syncDown(); renderList(); recalcStats(); return; } }
      await attachLocalAuth();
      const sess = getSession(); if(sess && readUsers()[sess]){ currentUser = sess; $('#userEmail').textContent = sess; $('#authView').classList.add('hidden'); $('#appView').classList.remove('hidden'); if(!(readData(sess)?.items?.length)) seedSamples(); renderList(); }
    })();
  </script>
</body>
</html>
